@using Directory.Infrastructure.Identity
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

<Modal @ref="modal" Title="Change Password">
    <BodyTemplate>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">@successMessage</div>
        }
        <div class="mb-3">
            <label class="form-label">Current Password</label>
            <input type="password" class="form-control" @bind="currentPassword" />
        </div>
        <div class="mb-3">
            <label class="form-label">New Password</label>
            <input type="password" class="form-control" @bind="newPassword" />
        </div>
        <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <input type="password" class="form-control" @bind="confirmPassword" />
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="HideAsync">Cancel</Button>
        <Button Color="ButtonColor.Primary" @onclick="ChangePassword">Change Password</Button>
    </FooterTemplate>
</Modal>

@code {
    private Modal modal = default!;
    private string currentPassword = string.Empty;
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    private string? errorMessage;
    private string? successMessage;

    public async Task ShowAsync()
    {
        currentPassword = string.Empty;
        newPassword = string.Empty;
        confirmPassword = string.Empty;
        errorMessage = null;
        successMessage = null;
        await modal.ShowAsync();
    }

    private async Task HideAsync()
    {
        await modal.HideAsync();
    }

    private async Task ChangePassword()
    {
        errorMessage = null;
        successMessage = null;

        if (newPassword != confirmPassword)
        {
            errorMessage = "New password and confirmation do not match.";
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var appUser = await UserManager.GetUserAsync(authState.User);
        if (appUser == null)
        {
            errorMessage = "User not found.";
            return;
        }

        var result = await UserManager.ChangePasswordAsync(appUser, currentPassword, newPassword);
        if (result.Succeeded)
        {
            successMessage = "Password changed successfully.";
            currentPassword = string.Empty;
            newPassword = string.Empty;
            confirmPassword = string.Empty;
        }
        else
        {
            errorMessage = string.Join("; ", result.Errors.Select(e => e.Description));
        }
    }
}
