@if (RelatedMembers.Count > 0)
{
    <table class="table table-sm table-bordered mb-3">
        <thead>
            <tr>
                <th>Name</th>
                <th>Relationship</th>
                <th style="width: 60px;"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var rel in RelatedMembers)
            {
                <tr>
                    <td>@rel.DisplayName</td>
                    <td>@rel.RelationshipTypeName</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => Remove(rel)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-muted mb-3">No related members.</p>
}

<div class="row g-2 align-items-end">
    <div class="col-md-5">
        <label class="form-label">Member</label>
        <select class="form-select" @bind="selectedMemberId">
            <option value="0">-- Select --</option>
            @foreach (var m in filteredMembers)
            {
                <option value="@m.Id">@m.Name</option>
            }
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Relationship</label>
        <select class="form-select" @bind="selectedRelTypeId">
            @foreach (var r in RelationshipTypes)
            {
                <option value="@r.Id">@r.Name</option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <button type="button" class="btn btn-success btn-sm" @onclick="Add">
            <i class="bi bi-plus-circle"></i> Add
        </button>
    </div>
</div>

@code {
    [Parameter] public List<RelatedMemberDto> RelatedMembers { get; set; } = new();
    [Parameter] public List<LookupDto> AllMembers { get; set; } = new();
    [Parameter] public List<LookupDto> RelationshipTypes { get; set; } = new();
    [Parameter] public int CurrentMemberId { get; set; }
    [Parameter] public EventCallback OnChanged { get; set; }

    private int selectedMemberId;
    private int selectedRelTypeId = 1;

    private IEnumerable<LookupDto> filteredMembers =>
        AllMembers.Where(m => m.Id != CurrentMemberId && !RelatedMembers.Any(r => r.MemberId == m.Id));

    private async Task Add()
    {
        if (selectedMemberId == 0) return;

        var member = AllMembers.FirstOrDefault(m => m.Id == selectedMemberId);
        var relType = RelationshipTypes.FirstOrDefault(r => r.Id == selectedRelTypeId);
        if (member == null || relType == null) return;

        RelatedMembers.Add(new RelatedMemberDto
        {
            MemberId = member.Id,
            DisplayName = member.Name,
            RelationshipTypeId = relType.Id,
            RelationshipTypeName = relType.Name
        });

        selectedMemberId = 0;
        await OnChanged.InvokeAsync();
    }

    private async Task Remove(RelatedMemberDto rel)
    {
        RelatedMembers.Remove(rel);
        await OnChanged.InvokeAsync();
    }
}
