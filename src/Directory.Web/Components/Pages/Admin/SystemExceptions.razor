@page "/admin/errors"
@attribute [Authorize(Roles = "SuperAdmin")]
@rendermode InteractiveServer
@inject ISystemExceptionService ExceptionService

<PageTitle>System Errors - CGBC Directory</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>System Errors</h3>
    <a href="/admin/users" class="btn btn-secondary">Back to Admin</a>
</div>

@if (exceptions == null)
{
    <p>Loading...</p>
}
else if (exceptions.Count == 0)
{
    <div class="alert alert-info">No errors logged.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead class="table-dark">
                <tr>
                    <th>Timestamp</th>
                    <th>Module</th>
                    <th>Message</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var ex in pagedExceptions)
                {
                    <tr>
                        <td style="white-space:nowrap">@ex.Timestamp.ToString("g")</td>
                        <td>@ex.Module</td>
                        <td>@ex.ExceptionMessage</td>
                        <td>
                            @if (!string.IsNullOrEmpty(ex.StackTrace))
                            {
                                <button class="btn btn-link btn-sm" @onclick="() => ToggleStack(ex.Id)">
                                    @(expandedId == ex.Id ? "Hide" : "Stack")
                                </button>
                            }
                        </td>
                    </tr>
                    @if (expandedId == ex.Id)
                    {
                        <tr>
                            <td colspan="4">
                                <pre class="bg-light p-2" style="max-height:300px;overflow:auto;font-size:0.8em;">@ex.StackTrace</pre>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (totalPages > 1)
    {
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => GoToPage(currentPage - 1)">Previous</button>
                </li>
                @for (int i = 1; i <= totalPages; i++)
                {
                    var pg = i;
                    <li class="page-item @(currentPage == pg ? "active" : "")">
                        <button class="page-link" @onclick="() => GoToPage(pg)">@pg</button>
                    </li>
                }
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => GoToPage(currentPage + 1)">Next</button>
                </li>
            </ul>
        </nav>
    }
}

@code {
    private List<SystemExceptionDto>? exceptions;
    private IEnumerable<SystemExceptionDto> pagedExceptions = Enumerable.Empty<SystemExceptionDto>();
    private int? expandedId;
    private int currentPage = 1;
    private const int PageSize = 25;
    private int totalPages;

    protected override async Task OnInitializedAsync()
    {
        exceptions = await ExceptionService.GetAllAsync();
        ApplyPaging();
    }

    private void ApplyPaging()
    {
        if (exceptions == null) return;
        totalPages = Math.Max(1, (int)Math.Ceiling((double)exceptions.Count / PageSize));
        pagedExceptions = exceptions.Skip((currentPage - 1) * PageSize).Take(PageSize);
    }

    private void GoToPage(int pg)
    {
        if (pg < 1 || pg > totalPages) return;
        currentPage = pg;
        ApplyPaging();
    }

    private void ToggleStack(int id)
    {
        expandedId = expandedId == id ? null : id;
    }
}
